name: Release

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Verify admin permissions
        run: |
          # Use the repository's permission endpoint which works for both personal and org repos
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/collaborators/${{ github.actor }}/permission")
          
          # Extract permission using jq if available, otherwise use grep
          if command -v jq &> /dev/null; then
            PERMISSION=$(echo "$RESPONSE" | jq -r '.permission // empty')
          else
            PERMISSION=$(echo "$RESPONSE" | grep -o '"permission":"[^"]*"' | head -1 | cut -d'"' -f4)
          fi
          
          if [ -z "$PERMISSION" ]; then
            echo "Warning: Could not determine permission level. Response: $RESPONSE"
            echo "Note: workflow_dispatch requires write access, proceeding..."
            exit 0
          fi
          
          if [ "$PERMISSION" != "admin" ]; then
            echo "Error: Only repository admins can trigger releases. Current permission: $PERMISSION"
            exit 1
          fi
          
          echo "✓ Verified admin permission for ${{ github.actor }}"

      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup git branch
        run: |
          git fetch --all --tags
          git checkout -B main
          git branch --set-upstream-to=origin/main main

      - name: Debug branch info
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "All branches: $(git branch -a)"
          echo "Git remote: $(git remote -v)"
          echo "Git status: $(git status)"

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          always-auth: true

      - run: npm ci

      - run: npm test --if-present

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create initial tag if needed
        run: |
          if ! git rev-parse --verify "v1.0.0-beta.1" >/dev/null 2>&1; then
            echo "Creating initial tag v1.0.0-beta.1"
            git tag -a "v1.0.0-beta.1" -m "chore: initial beta release"
            git push origin "v1.0.0-beta.1" || echo "Tag push failed (may not have permission or tag exists)"
          else
            echo "Tag v1.0.0-beta.1 already exists"
          fi

      - name: Debug semantic-release config
        run: |
          echo "=== .releaserc.json ==="
          cat .releaserc.json
          echo ""
          echo "=== Git branches ==="
          git branch -a
          echo ""
          echo "=== Current branch ==="
          git branch --show-current
          echo ""
          echo "=== Git tags ==="
          git tag

      - name: Extract npm token from .npmrc
        run: |
          echo "=== Extracting npm token ==="
          echo "NPM_CONFIG_USERCONFIG: $NPM_CONFIG_USERCONFIG"
          echo "NODE_AUTH_TOKEN is set: $([ -n "$NODE_AUTH_TOKEN" ] && echo 'yes' || echo 'no')"
          
          # Copy .npmrc to multiple locations
          if [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            # Copy to home directory
            mkdir -p ~/.npm
            cp "$NPM_CONFIG_USERCONFIG" ~/.npmrc
            echo "✓ Copied .npmrc to ~/.npmrc"
            
            # Also copy to repository root (semantic-release might look there)
            cp "$NPM_CONFIG_USERCONFIG" .npmrc
            echo "✓ Copied .npmrc to repository root"
            
            # Show .npmrc format (masked) for debugging
            echo ""
            echo "Contents of .npmrc (masked):"
            cat ~/.npmrc | sed 's/=.*/=***/' || true
            echo ""
            
            # Extract token - try multiple methods
            NPM_TOKEN=""
            
            # Method 1: awk
            NPM_TOKEN=$(awk -F'=' '/_authToken/ {print $2}' ~/.npmrc | head -1 | tr -d '\n\r' || echo "")
            
            # Method 2: grep with regex
            if [ -z "$NPM_TOKEN" ]; then
              NPM_TOKEN=$(grep -oP '(?<=_authToken=).*' ~/.npmrc | head -1 | tr -d '\n\r' || echo "")
            fi
            
            # Method 3: simple sed
            if [ -z "$NPM_TOKEN" ]; then
              NPM_TOKEN=$(grep '_authToken' ~/.npmrc | sed 's/.*_authToken=//' | head -1 | tr -d '\n\r' || echo "")
            fi
            
            # Method 4: Check if it's a variable reference
            if [ -z "$NPM_TOKEN" ] || [[ "$NPM_TOKEN" == \$\{*\} ]]; then
              echo "Token appears to be a variable reference, using NODE_AUTH_TOKEN"
              if [ -n "$NODE_AUTH_TOKEN" ]; then
                NPM_TOKEN="$NODE_AUTH_TOKEN"
              fi
            fi
            
            if [ -n "$NPM_TOKEN" ] && [ "$NPM_TOKEN" != "\${NODE_AUTH_TOKEN}" ]; then
              echo "::add-mask::$NPM_TOKEN"
              echo "NPM_TOKEN=$NPM_TOKEN" >> $GITHUB_ENV
              echo "✓ NPM_TOKEN extracted and set (length: ${#NPM_TOKEN} chars)"
            else
              echo "✗ Error: Could not extract valid token from .npmrc"
              echo "Token value: '$NPM_TOKEN'"
              echo ""
              echo "Full .npmrc content (first 10 lines, tokens masked):"
              head -10 ~/.npmrc | sed 's/=.*/=***/' || true
              exit 1
            fi
          else
            echo "✗ Error: .npmrc file not found at $NPM_CONFIG_USERCONFIG"
            echo "This means actions/setup-node did not create the .npmrc file"
            echo "Checking if NODE_AUTH_TOKEN can be used directly..."
            if [ -n "$NODE_AUTH_TOKEN" ]; then
              echo "::add-mask::$NODE_AUTH_TOKEN"
              echo "NPM_TOKEN=$NODE_AUTH_TOKEN" >> $GITHUB_ENV
              echo "✓ Using NODE_AUTH_TOKEN directly as NPM_TOKEN"
            else
              exit 1
            fi
          fi
          
          # Test authentication
          echo ""
          echo "=== Testing npm authentication ==="
          if npm whoami --registry=https://registry.npmjs.org 2>/dev/null; then
            echo "✓ npm authentication successful"
          else
            echo "✗ npm authentication test failed"
            echo "Note: This might be OK - semantic-release will verify the token"
          fi

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
